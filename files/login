from apiclient.discovery import build
from oauth2client import tools
from oauth2client.file import Storage
from oauth2client.client import AccessTokenRefreshError
from oauth2client.client import flow_from_clientsecrets as FFC
import httplib2
import json
import pathlib
import subprocess
import pickle
import os
import io


with open('/tmp/params.dat', 'rb') as f:
  try:
    params = pickle.load(f)
  except EOFError:
    params = None
subprocess.run('sudo rm /tmp/flow.dat /tmp/params.dat', shell=True)
w = json.loads(str(os.environ['GOOGLE-CLIENT-SECRETS']).replace('\'', '\"'))
print(w)
with open('/tmp/client_secrets.json', 'w') as f:
  json.dump(w, f)

try:
  flow = FFC(io.StringIO(json.loads(str(os.environ['GOOGLE-CLIENT-SECRETS']).replace('\'', '\"'))), scope=('https://www.googleapis.com/auth/userinfo.profile', 'https://www.googleapis.com/auth/userinfo.email'), redirect_uri='http://jath03.herokuapp.com/{}'.format(str(params['redirect'])))
except (KeyError, TypeError) as err:
  flow = FFC('/tmp/client_secrets.json', scope=('https://www.googleapis.com/auth/userinfo.profile', 'https://www.googleapis.com/auth/userinfo.email'), redirect_uri='http://jath03.herokuapp.com')
with open('/tmp/flow.dat', 'wb') as f:
  pickle.dump(flow, f)


def main():
  auth_uri = flow.step1_get_authorize_url()
  print('''<!DOCTYPE html>
<html>
	<head>
		<script>window.location = "{}";</script>
	</head>
	<body>
		<h1>Hello</h1>
	</body>
</html>'''.format(auth_uri))
if __name__ == '__main__':
  try:
    main()
  except KeyboardInterrupt:
    subprocess.run(['sudo rm /home/jack/.creds/credentials.dat'])

